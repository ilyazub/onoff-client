(function(){"use strict";angular.module("onoffClientApp",["ngRoute","restangular","ngStorage","ilyazub.dragndrop-object","angulartics","angulartics.google.analytics"]).config(["$routeProvider",function(a){return a.when("/",{templateUrl:"views/foreman.html",controller:"ForemanCtrl"}).when("/carts/:cartId/series",{templateUrl:"views/series.html",controller:"SeriesCtrl"}).when("/admin",{templateUrl:"/views/admin.html",controller:"AdminCtrl"}).otherwise({redirectTo:"/"})}]).config(["RestangularProvider","apiUrl",function(a,b){return a.setBaseUrl(b),a.setDefaultHttpFields({cache:!0})}])}).call(this),function(){"use strict";angular.module("onoffClientApp").controller("ForemanCtrl",["$scope","Restangular","CartsModel","DevicesSvc","CartItemsModel",function(a,b,c,d,e){var f,g;return g=function(b){return a.devices=b},f=function(b){return a.cart=b,a.cartItems=new e({service:a.cart.cartItems})},a.cart={},a.devices=[],d.getList().then(g),c.initialize(f)}])}.call(this),function(){"use strict";angular.module("onoffClientApp").constant("apiUrl","/api")}.call(this),function(){"use strict";angular.module("onoffClientApp").factory("CartsSvc",["Restangular",function(a){return a.extendModel("carts",function(b){return b.removeAll=function(){return b.remove().then(function(){return b.cartItems.length=0})},b.restangularizeNested=function(){return a.restangularizeCollection(b,b.cartItems,"cart_items")},b}),a.service("carts")}])}.call(this),function(){"use strict";angular.module("onoffClientApp").factory("DevicesSvc",["Restangular",function(a){return a.service("devices")}])}.call(this),function(){"use strict";angular.module("onoffClientApp").factory("CartItemsSvc",["Restangular",function(a){return a.extendCollection("cart_items",function(a){return a.add=function(b){var c;return c=a.indexOf(b),-1===c&&a.push(b),a},a["delete"]=function(b){var c;return c=a.indexOf(b),-1!==c&&a.splice(c,1),a},a}),a.service("cart_items")}])}.call(this),function(){"use strict";angular.module("onoffClientApp").directive("devices",function(){return{templateUrl:"views/devices.html",restrict:"EA"}})}.call(this),function(){"use strict";angular.module("onoffClientApp").directive("cartItems",function(){return{templateUrl:"views/cartitems.html",restrict:"EA"}})}.call(this),function(){"use strict";angular.module("onoffClientApp").directive("series",function(){return{templateUrl:"views/series.html",restrict:"EA"}})}.call(this),function(){"use strict";angular.module("onoffClientApp").factory("CartsModel",["$localStorage","CartsSvc",function(a,b){var c;return c=a.cart,{initialize:function(a){return c?b.one(c.id).put().then(function(b){return function(c){return b.initializeCart(c,a)}}(this)):b.post().then(function(b){return function(c){return b.initializeCart(c,a)}}(this))},initializeCart:function(b,d){return d(b),a.$reset({cart:{id:b.id}}),c=a.cart,b.restangularizeNested()}}}])}.call(this),function(){"use strict";var a=function(a,b){return function(){return a.apply(b,arguments)}};angular.module("onoffClientApp").factory("CartItemsModel",["CartItemsSvc",function(){var b;return b=function(){function b(b){var c;this._options=b,this._updateItem=a(this._updateItem,this),this._addItem=a(this._addItem,this),this.remove=a(this.remove,this),this.update=a(this.update,this),this.add=a(this.add,this),c=this._options,this.model=c.model,this.collection=c.collection,this.service=c.service}return b.prototype.add=function(a){var b,c;return b=this._newCartItem(a),null!=(c=this.service)?c.post(b).then(this._addItem):void 0},b.prototype.update=function(a){return a.put().then(this._updateItem,function(a){return console.warn(a)})},b.prototype.remove=function(a){return a.remove().then(angular.bind(this,this._deleteItem,a),function(a){return console.warn(a)})},b.prototype._addItem=function(a){var b;return null!=(b=this.service)?b.add(a):void 0},b.prototype._updateItem=function(){},b.prototype._deleteItem=function(a,b){var c;return null!=(c=this.service)?c["delete"](a,b):void 0},b.prototype._newCartItem=function(a){return{device_id:a.id,amount:1}},b}()}])}.call(this),function(){"use strict";var a=[].slice,b={}.hasOwnProperty,c=function(a,c){function d(){this.constructor=a}for(var e in c)b.call(c,e)&&(a[e]=c[e]);return d.prototype=c.prototype,a.prototype=new d,a.__super__=c.prototype,a};angular.module("onoffClientApp").controller("SeriesCtrl",["$scope","$http","$routeParams","Restangular","CartsSvc",function(b,d,e,f,g){var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J;for(b.cartId=e.cartId,p=f.setDefaultHttpFields({cache:!1}),j=g.one(b.cartId),u=p.service("series",j),j.put().then(function(a){return b.newCart=new m({id:b.cartId,cartItems:a.cartItems}),b.newCart.loadSeries()}),i=function(){function a(a,b){this.attributes=null!=a?a:{},this.options=null!=b?b:{},this.defineProperties(),this.options.collection&&(this.collection=this.options.collection),this.initialize(this.attributes,this.options)}return a.prototype.initialize=function(){},a.prototype.defineProperties=function(){var a,b,c,d;c=this.attributes,d=[];for(a in c)b=c[a],d.push(this.defineProperty(a,b));return d},a.prototype.defineProperty=function(a,b){var c;return c=this,c.attributes[a]=b,function(a){return Object.defineProperty(c,a,{enumerable:!0,configurable:!0,get:function(){return c.attributes[a]},set:function(b){return c.attributes[a]=b}})}(a)},a.prototype.toJSON=function(){return angular.copy(this.attributes)},a}(),I=["has"],E=0,G=I.length;G>E;E++)D=I[E],i.prototype[D]=function(){var b;return b=1<=arguments.length?a.call(arguments,0):[],b.unshift(this.attributes),_[D].apply(_,b)};for(h=function(){function a(a,b){null==a&&(a=[]),null==b&&(b={}),b.model&&(this.model=b.model),this.reset(a,b),this.initialize(a,b)}return a.prototype.model=i,a.prototype.initialize=function(){},a.prototype.reset=function(a,b){var c;return this.models=function(){var d,e,f;for(f=[],d=0,e=a.length;e>d;d++)c=a[d],b.collection=this,f.push(new this.model(c,b));return f}.call(this)},a.prototype.findWhere=function(a){return _.find(this.models,function(b){var c,d;for(c in a)if(d=a[c],b[c]!==d)return!1;return!0},this)},a.prototype.size=function(){return this.models.length},a.prototype.toJSON=function(){var a,b,c,d,e;for(d=this.models,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(a.toJSON());return e},a}(),J=["pluck","where","find","reduce"],F=0,H=J.length;H>F;F++)D=J[F],h.prototype[D]=function(){var b;return b=1<=arguments.length?a.call(arguments,0):[],b.unshift(this.models),_[D].apply(_,b)};return m=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.initialize=function(){return this.expanded=!0,this.cartItems=new l(this.cartItems,{cart:this})},b.prototype.loadSeries=function(){return u.getList().then(function(a){return function(b){return a.series=new v(b.plain(),{cart:a})}}(this))},b.prototype.amountOfDevices=function(a){return this.cartItems.amountOfDevices(a)},b}(i),k=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.initialize=function(){return this.device=new n(this.device,{cartItem:this})},b.prototype.amountOfDevices=function(a){return this.device.id===a?this.amount:0},b}(i),l=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.model=k,b.prototype.amountOfDevices=function(a){return this.reduce(function(b,c){return b+c.amountOfDevices(a)},0)},b}(h),n=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b}(i),o=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.model=n,b}(i),w=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.initialize=function(){return this.parameters=new r(this.parameters,{series:this,cart:this.options.cart}),this.skus=new s(this.skus,{series:this})},b.prototype.price=function(){return this.skus.price(this.parameters,this.options.cart)},b.prototype.toJSON=function(){var a;return a=b.__super__.toJSON.apply(this,arguments),delete a.title,delete a.manufacturer,a},b}(i),v=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.model=w,b}(h),q=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.initialize=function(){return this.values=new C(this.values,{parameter:this,series:this.options.series,cart:this.options.cart})},b.prototype.selectedValue=function(){return this.values.selectedValue()},b.prototype.selectedValueId=function(){return this.values.selectedValueId()},b.prototype.toJSON=function(){var a;return a=b.__super__.toJSON.apply(this,arguments),delete a.variable,delete a.description,a},b}(i),r=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.model=q,b}(h),B=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.initialize=function(){return this.selected?this.update():void 0},b.prototype.select=function(){return this.selected?void 0:(this.collection.unselect(),this.selected=!0,this.update())},b.prototype.unselect=function(){return this.selected=!1},b.prototype.update=function(){return d.put("/api/carts/"+this.options.cart.id+"/values",angular.toJson(this))},b.prototype.toJSON=function(){var a;return a=b.__super__.toJSON.apply(this,arguments),delete a.code,delete a.description,a.parameter_id=this.options.parameter.id,a},b}(i),C=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.model=B,b.prototype.selectedValue=function(){return this.findWhere({selected:!0})},b.prototype.selectedValueId=function(){return this.selectedValue().id},b.prototype.unselect=function(){var a,b,c,d,e;for(d=this.models,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(a.unselect());return e},b}(h),t=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.initialize=function(){return this.skuParameters=new y(this.parameters,{sku:this})},b.prototype.price=function(a,b){var c;return c=this.unitPrice>0&&0===this.skuParameters.size()?this.unitPrice:this.skuParameters.price(a),c*this.amount*b.amountOfDevices(this.deviceId)},b}(i),s=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.model=t,b.prototype.price=function(a,b){return this.reduce(function(c,d){return c+d.price(a,b)},0)},b}(h),x=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.initialize=function(){return this.skuValues=new A(this.values,{parameter:this})},b.prototype.price=function(a){return a.reduce(function(a,b){return this.parameterId===b.id?a+this.getValuePrice(b.selectedValueId()):a},0,this)},b.prototype.getValuePrice=function(a){return this.skuValues.get(a).unitPrice},b}(i),y=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.model=x,b.prototype.price=function(a){return this.reduce(function(b,c){return b+c.price(a)},0)},b}(h),z=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b}(i),A=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.model=z,b.prototype.get=function(a){return this.findWhere({valueId:a})},b}(h)}])}.call(this),function(){"use strict";angular.module("onoffClientApp").controller("AdminCtrl",["$scope","$http","apiUrl",function(a,b,c){var d,e;return a.uploads={catalogue:{},priceList:{},clearDb:!1,images:[],isUploading:!1,submitButtonLabel:"Загрузить",url:c+"/admin/upload"},d=function(a,b,c){return angular.forEach(b,function(b){return a.append(c,b)})},e=function(){return angular.forEach(a.uploads.images,function(c){var d;return d=new FormData,d.append("image",c),b.post(a.uploads.url+"/images",d,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(function(){return a.uploads.isUploading=!1,a.uploads.submitButtonLabel="Загрузить"})})},a.upload=function(){var c;return c=new FormData,d(c,a.uploads.catalogue,"catalogue"),d(c,a.uploads.priceList,"price_list"),c.append("clear_db",a.uploads.clearDb),e(),a.uploads.isUploading=!0,a.uploads.submitButtonLabel="Загружаю...",b.post(a.uploads.url,c,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(function(){return a.uploads.isUploading=!1,a.uploads.submitButtonLabel="Загрузить"})}}])}.call(this),function(){"use strict";angular.module("onoffClientApp").directive("fileInput",["$parse",function(a){return{restrict:"A",link:function(b,c,d){return c.on("change",function(){return a(d.fileInput).assign(b,c[0].files),b.$apply()})}}}])}.call(this);